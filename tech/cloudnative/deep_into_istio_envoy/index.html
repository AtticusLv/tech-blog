<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>深挖Istio中Envoy原理和配置</title><meta name=author content="大倬"><meta name=author-link content><meta name=description content="Envoy是service mesh中常用的数据面板（data plane），用来流量劫持和转发的。istio（一种控制面板的实现方式）中常是用"><meta name=keywords content="istio,envoy"><meta itemprop=name content="深挖Istio中Envoy原理和配置"><meta itemprop=description content="Envoy是service mesh中常用的数据面板（data plane），用来流量劫持和转发的。istio（一种控制面板的实现方式）中常是用"><meta itemprop=datePublished content="2023-03-02T14:01:06+08:00"><meta itemprop=dateModified content="2023-03-02T14:01:06+08:00"><meta itemprop=wordCount content="3185"><meta itemprop=keywords content="istio,envoy,"><meta property="og:title" content="深挖Istio中Envoy原理和配置"><meta property="og:description" content="Envoy是service mesh中常用的数据面板（data plane），用来流量劫持和转发的。istio（一种控制面板的实现方式）中常是用"><meta property="og:type" content="article"><meta property="og:url" content="https://nuoyang.tech/tech/cloudnative/deep_into_istio_envoy/"><meta property="article:section" content="tech"><meta property="article:published_time" content="2023-03-02T14:01:06+08:00"><meta property="article:modified_time" content="2023-03-02T14:01:06+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="深挖Istio中Envoy原理和配置"><meta name=twitter:description content="Envoy是service mesh中常用的数据面板（data plane），用来流量劫持和转发的。istio（一种控制面板的实现方式）中常是用"><meta name=application-name content="大倬"><meta name=apple-mobile-web-app-title content="大倬"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://nuoyang.tech/tech/cloudnative/deep_into_istio_envoy/><link rel=prev href=https://nuoyang.tech/tech/cloudnative/istio_proxy_log_level/><link rel=next href=https://nuoyang.tech/tech/cloudnative/istio_ratelimit_circuit_breaker/><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"深挖Istio中Envoy原理和配置","inLanguage":"zh-cn","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/nuoyang.tech\/tech\/cloudnative\/deep_into_istio_envoy\/"},"genre":"tech","keywords":"istio, envoy","wordcount":3185,"url":"https:\/\/nuoyang.tech\/tech\/cloudnative\/deep_into_istio_envoy\/","datePublished":"2023-03-02T14:01:06+08:00","dateModified":"2023-03-02T14:01:06+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"大倬"},"description":""}</script></head><body data-header-desktop=sticky data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=大倬个人技术博客><span id=typeit-header-desktop class=typeit></span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 博客</a></li><li class="menu-item active has-children"><a class=menu-link href=/tech/><i class="fa-solid fa-book fa-fw fa-sm" aria-hidden=true></i> 技术文档</a><i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden=true></i><ul class=sub-menu><li class="menu-item active"><a class=menu-link href=/tech/%E4%BA%91%E5%8E%9F%E7%94%9F/ title=架构文档><i class="fa-brands fa-readme fa-fw fa-sm" aria-hidden=true></i> 云原生</a></li><li class=menu-item><a class=menu-link href=/tech/%E6%9E%B6%E6%9E%84/ title=架构文档><i class="fa-brands fa-readme fa-fw fa-sm" aria-hidden=true></i> 架构目录</a></li><li class=menu-item><a class=menu-link href=/tech/%E5%85%B6%E4%BB%96/ title=架构文档><i class="fa-brands fa-readme fa-fw fa-sm" aria-hidden=true></i> 其他</a></li></ul></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容…… id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=大倬个人技术博客><span id=typeit-header-title-mobile class=typeit></span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容…… id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 博客</a></li><li class="menu-item active"><span class=nested-item><a class=menu-link href=/tech/><i class="fa-solid fa-book fa-fw fa-sm" aria-hidden=true></i> 技术文档</a>
<i class="dropdown-icon fa-solid fa-chevron-right" aria-hidden=true></i></span><ul class=sub-menu><li class="menu-item active"><a class=menu-link href=/tech/%E4%BA%91%E5%8E%9F%E7%94%9F/ title=架构文档><i class="fa-brands fa-readme fa-fw fa-sm" aria-hidden=true></i> 云原生</a></li><li class=menu-item><a class=menu-link href=/tech/%E6%9E%B6%E6%9E%84/ title=架构文档><i class="fa-brands fa-readme fa-fw fa-sm" aria-hidden=true></i> 架构目录</a></li><li class=menu-item><a class=menu-link href=/tech/%E5%85%B6%E4%BB%96/ title=架构文档><i class="fa-brands fa-readme fa-fw fa-sm" aria-hidden=true></i> 其他</a></li></ul></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container data-page-style=normal><aside class=toc id=toc-auto><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>深挖Istio中Envoy原理和配置</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><i class="fa-solid fa-user-circle" aria-hidden=true></i>
大倬</span></span>
<span class=post-category>收录于 <a href=/categories/%E6%8A%80%E6%9C%AF/><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> 技术</a></span></div><div class=post-meta-line><span title="2023-03-02 14:01:06"><i class="fa-regular fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-03-02>2023-03-02</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw" aria-hidden=true></i> 约 3185 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw" aria-hidden=true></i> 预计阅读 7 分钟</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#envoy>Envoy</a><ul><li><a href=#一些术语>一些术语</a></li><li><a href=#关于xds版本>关于xDS版本</a></li><li><a href=#istio和envoy关系>istio和envoy关系</a><ul><li><a href=#istioenvoy启动过程>istio+envoy启动过程</a></li></ul></li><li><a href=#envoy-proxy配置解析>envoy proxy配置解析</a><ul><li><a href=#boostrap>boostrap</a></li><li><a href=#服务发现类型>服务发现类型</a></li><li><a href=#两个特殊的cluster>两个特殊的cluster</a></li><li><a href=#特殊listener>特殊listener</a></li></ul></li><li><a href=#一次请求在envoy中经过了什么>一次请求在Envoy中经过了什么</a></li><li><a href=#bookinfo示例调用过程>Bookinfo示例调用过程</a></li></ul></li><li><a href=#参考资料>参考资料</a></li></ul></li></ul></nav></div></div><div class=content id=content><blockquote><p>Envoy是service mesh中常用的数据面板（data plane），用来流量劫持和转发的。istio（一种控制面板的实现方式）中常是用envoy来作为sidecar，istio在envoy的xDS协议上做了很多扩展逻辑，流量劫持背后主要通过iptables技术将出入pod流量都劫持到sidecar上，这里主要参考Jimmy Song大佬的博客，深挖下enovy的基本原理和相关配置，收集整理了下相关资料</p></blockquote><h2 id=envoy>Envoy</h2><p>转一张envoy的架构图(转自<a href=jimmysong.io>jimmysong.io</a>)</p><p><img loading=lazy src=index.assets/image-20230302140436518.png srcset="/tech/cloudnative/deep_into_istio_envoy/index.assets/image-20230302140436518.png, index.assets/image-20230302140436518.png 1.5x, /tech/cloudnative/deep_into_istio_envoy/index.assets/image-20230302140436518.png 2x" sizes=auto data-title=image-20230302140436518 data-alt=image-20230302140436518 width=739 height=500 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><h3 id=一些术语>一些术语</h3><ul><li><p>Downstream</p><p>下游服务，指连接到envoy的服务，这些服务发送请求到envoy，并接收envoy响应</p></li><li><p>Upstream</p><p>上游服务，指接收envoy连接和请求的服务，并将响应返回给envoy</p></li><li><p>Listener</p><p>监听器，envoy暴露一个活多个listener来监听downstream的请求；当listener监听到请求时，会交给filter chains处理</p></li><li><p>Cluster</p><p>envoyy连接的一组逻辑相同的upstream服务；envoy通过service discovery来发现cluster成员，通过load balance将流量路由到cluster的各个成员去</p></li><li><p>xDS</p><p>xDS中的x是一个代词，x指一系列的，DS=Discovery Service发现服务，目前是envoy作为数据面板的api实现规范，可以在<a href=https://github.com/envoyproxy/envoy/tree/main/api target=_blank rel="external nofollow noopener noreferrer">envoy api</a>中看到具体实现，<a href=https://www.envoyproxy.io/docs/envoy/latest/api-docs/xds_protocol target=_blank rel="external nofollow noopener noreferrer">xDS REST and gRPC protocol文档</a></p><p>xDS包括：</p><ul><li>LDS: listener discovery service</li><li>RDS: route discovery service</li><li>SRDS: scoped route discovery service</li><li>VHDS: virtual host discovery service</li><li>CDS: cluster discovery service</li><li>EDS: endpoint discovery service</li><li>SDS: secret discovery service</li><li>RTDS: runtime discovery service</li><li>ADS: aggregated discovery service, 这是个特殊的，是对其他的一种聚合统一封装</li></ul></li></ul><h3 id=关于xds版本>关于xDS版本</h3><p>​ xDS在envoy和mesh架构中是一个很重要的概念，也是选址规则的核心逻辑。目前envoy的xDS协议有v1和v2版本，在isito1.0+版本中只支持v2版本的xDS API了，目前istio官网的bookinfo示例中也是指定了<code>--v2-config-only</code> ，需要注意的是v2版本并不直接向下兼容v1版本。envoy不同版本对v1和v2版本的支持。</p><p>​ 关于xDS，CNCF已经开源出来了，也是主流的数据面板的api规范，感兴趣可以到<a href=https://github.com/cncf/xds target=_blank rel="external nofollow noopener noreferrer">cncf/xds</a>查看下，最新官网已经出了v3的版本，仍在开发中。v2版本是当前的稳定版本。</p><h3 id=istio和envoy关系>istio和envoy关系</h3><p><img loading=lazy src=index.assets/1620.jpeg srcset="/tech/cloudnative/deep_into_istio_envoy/index.assets/1620.jpeg, index.assets/1620.jpeg 1.5x, /tech/cloudnative/deep_into_istio_envoy/index.assets/1620.jpeg 2x" sizes=auto data-title=img data-alt=img width=554 height=323 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p>​ envoy与业务服务部署在同一个pod中，共享网络和namespace，envoy通过iptables技术劫持业务服务的进出流量，按照istio下发的流量规则去路由流量。其中envoy的容器中部署了istio的探针——pilot-agent，在启动时istio会为envoy注入bootstrap配置，其余和动态的配置会通过pilot下发。</p><p>​ 在整个数据平面中，各个envoy的动态配置应该是相同的，可以通过<code>istioctl ps</code>命令查看各个sidecar的配置是否同步</p><p>​ 运行时，可以在sidecar容器内通过命令行查看envoy proxy配置是否同步</p><pre tabindex=0><code>curl http://localhost:15000/config_dump
</code></pre><p>​ 也可以通过kubectl命令将文件dump下来</p><pre tabindex=0><code>kubectl -n default exec ratings-v1-7c9949d479-dwkr4 -c istio-proxy curl http://localhost:15000/config_dump &gt; dump-rating.json
</code></pre><p>​ 这里用到了envoy的admin接口，详细的admin接口介绍可以在envoy文档中看到</p><h4 id=istioenvoy启动过程>istio+envoy启动过程</h4><h3 id=envoy-proxy配置解析>envoy proxy配置解析</h3><p>​ istio部署的istio-proxy(即envoy sidecar，部署时名字命名为istio-proxy)，包含以下几个部分：</p><ul><li><p><strong>bootstrap</strong>: envoy启动时加载的静态配置</p></li><li><p><strong>listeners</strong>: 监听器配置，通过LDS下发</p></li><li><p><strong>clusters</strong>: 集群配置，静态配置中包括xds-grpc和zipkin地址，动态配置使用CDS下发</p><p>cluster分为inbound和outbound，inbound对应envoy所在pod上的服务，outbound占了大多数，对应envoy所在pod以外的服务</p></li><li><p><strong>routes</strong>: 路由配置，静态配置中包括了本地监听的服务集群信息，引用了cluster，动态配置使用RDS下发</p></li></ul><p>每个部分都包括静态配置和动态配置，其中bootstrap配置是在集群启动时通过istio-proxy的启动参数注入的，配置文件在<code> /etc/istio/proxy/envoy-rev0.json</code></p><p>以官方bookinfo工程示例，可以看到下面的配置</p><p><img loading=lazy src=index.assets/image-20221102171931411.png srcset="/tech/cloudnative/deep_into_istio_envoy/index.assets/image-20221102171931411.png, index.assets/image-20221102171931411.png 1.5x, /tech/cloudnative/deep_into_istio_envoy/index.assets/image-20221102171931411.png 2x" sizes=auto data-title=image-20221102171931411 data-alt=image-20221102171931411 width=616 height=739 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p>如果部署了kiali，也可以在workload的面板中看到envoy的各个配置信息</p><p><img loading=lazy src=index.assets/image-20221102172452777.png srcset="/tech/cloudnative/deep_into_istio_envoy/index.assets/image-20221102172452777.png, index.assets/image-20221102172452777.png 1.5x, /tech/cloudnative/deep_into_istio_envoy/index.assets/image-20221102172452777.png 2x" sizes=auto data-title=image-20221102172452777 data-alt=image-20221102172452777 width=3396 height=1786 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><h4 id=boostrap>boostrap</h4><p><img loading=lazy src=index.assets/image-20221103103840628.png srcset="/tech/cloudnative/deep_into_istio_envoy/index.assets/image-20221103103840628.png, index.assets/image-20221103103840628.png 1.5x, /tech/cloudnative/deep_into_istio_envoy/index.assets/image-20221103103840628.png 2x" sizes=auto data-title=image-20221103103840628 data-alt=image-20221103103840628 width=1766 height=500 style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><h4 id=服务发现类型>服务发现类型</h4><p>cluster 的服务发现类型主要有：</p><ul><li><strong>ORIGINAL_DST</strong>：类型的 Cluster，Envoy 在转发请求时会直接采用 downstream 请求中的原始目的地 IP 地址</li><li><strong>EDS</strong>：EDS 获取到该 Cluster 中所有可用的 Endpoint，并根据负载均衡算法（缺省为 Round Robin）将 Downstream 发来的请求发送到不同的 Endpoint。<strong>istio 会自动为集群中的 service 创建代理信息，listener 的信息从 service 获取，对应的 cluster 被标记为 EDS 类型</strong></li><li><strong>STATIC</strong>：缺省值，在集群中列出所有可代理的主机 Endpoints。当没有内容为空时，不进行转发。</li><li><strong>LOGICAL_DNS</strong>：Envoy 使用 DNS 添加主机，但如果 DNS 不再返回时，也不会丢弃。</li><li><strong>STRICT_DNS</strong>：Envoy 将监控 DNS，而每个匹配的 A 记录都将被认为是有效的。</li></ul><h4 id=两个特殊的cluster>两个特殊的cluster</h4><ul><li><p><strong>BlackHoleCluster</strong></p><p>匹配到BlackHoleCluster的流量不会被转发</p></li></ul><pre tabindex=0><code>{
    &#34;name&#34;: &#34;BlackHoleCluster&#34;,
    &#34;type&#34;: &#34;STATIC&#34;,
    &#34;connectTimeout&#34;: &#34;10s&#34;
}
</code></pre><ul><li><p><strong>PassthroughtCluster</strong></p><p>匹配到PassthroughCluster的流量数据包的目的ip不会改变</p></li></ul><pre tabindex=0><code>{
    &#34;name&#34;: &#34;PassthroughCluster&#34;,
    &#34;type&#34;: &#34;ORIGINAL_DST&#34;,
    &#34;connectTimeout&#34;: &#34;10s&#34;,
    &#34;lbPolicy&#34;: &#34;CLUSTER_PROVIDED&#34;,
    &#34;circuitBreakers&#34;: {
       &#34;thresholds&#34;: [
          {
              &#34;maxConnections&#34;: 4294967295,
               &#34;maxPendingRequests&#34;: 4294967295,
               &#34;maxRequests&#34;: 4294967295,
               &#34;maxRetries&#34;: 4294967295
            }
        ]
 }
</code></pre><p>类型为<code>ORIGINAL_DST</code> 流量将原样转发</p><h4 id=特殊listener>特殊listener</h4><p>envoy有一个特殊的listener——virtualOutbound</p><ul><li>virtualOutbound：每个envoy都有一个绑定到<code>0.0.0.0:15001</code>的listener，下面挂关联了许多virtual listener。</li></ul><p>iptables会先将所有出站流量导入该listener，其中有个字段<code>useOriginalDst</code>设置为<code>true</code>，表示会使用最佳匹配原始目的地的方式，将请求分发到和请求原目的地址关联的virtual listener处理；</p><p>如果没有找到任何的virtual listener，则根据istio的<code>outboundTrafficPolicy</code>全局配置选项进行处理，这里会有2种情况</p><ul><li><p>outboundTrafficPolicy: <strong>ALLOW_ANY</strong>: 网格允许法相任何外部服务的请求，不管改服务是否在pilot的服务注册表中，在这个策略下，pilot会在下发给envoy的VirtualOutbound Listener加入一个upstream cluster为PassthroughCluster的TCP proxy filter，找不到匹配端口的listener请求会被该TCP proxy filter处理，请求将会被发送到其IP头中的原始目的地址</p></li><li><p>outboundTrafficPolicy: <strong>REGISTRY_ONLY</strong>: 只允许法相Pilot服务注册表中存在的服务对外请求。这种策略下，Pilot将会再下发给Envoy的VirtualOutbound Listener加入一个upstream cluster位BlackHoleCluster的TCP proxy filter，找不到匹配端口listener的请求会被该TCP proxy filter处理，由于BlackHoleCluster中没有配置upstream host，请求实际上会被丢弃</p></li></ul><h3 id=一次请求在envoy中经过了什么>一次请求在Envoy中经过了什么</h3><p>在官网<a href=https://www.envoyproxy.io/docs/envoy/latest/intro/life_of_a_request target=_blank rel="external nofollow noopener noreferrer">Life of a Request</a>章节中有详细描述：envoy可以简化为<strong>Listener</strong>和<strong>Cluster</strong>两个部分构成</p><ul><li>Listener：处理downstream请求，将响应体返回给downstream</li><li>Cluster：处理到upstream连接和请求，将请求直接发送到endpoint，其中包括cluster注册表、负载均衡、健康检查、连接池等</li></ul><p><img loading=lazy src=index.assets/lor-architecture.svg srcset="/tech/cloudnative/deep_into_istio_envoy/index.assets/lor-architecture.svg, index.assets/lor-architecture.svg 1.5x, /tech/cloudnative/deep_into_istio_envoy/index.assets/lor-architecture.svg 2x" sizes=auto data-title=../_images/lor-architecture.svg data-alt=../_images/lor-architecture.svg style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p>envoy是事件驱动模型，一进程多线程的方式，主线程主要处理envoy自身的生命周期、配置、监控等，每个请求都有独立的worker线程来处理的。每个work线程维护着到upstream各个endpoint的TCP连接池</p><h3 id=bookinfo示例调用过程>Bookinfo示例调用过程</h3><h2 id=参考资料>参考资料</h2><p><a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/arch_overview target=_blank rel="external nofollow noopener noreferrer">https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/arch_overview</a></p><p><a href=https://jimmysong.io/blog/envoy-proxy-config-deep-dive/ target=_blank rel="external nofollow noopener noreferrer">https://jimmysong.io/blog/envoy-proxy-config-deep-dive/</a></p><p><a href=https://jimmysong.io/blog/envoy-sidecar-injection-in-istio-service-mesh-deep-dive/ target=_blank rel="external nofollow noopener noreferrer">https://jimmysong.io/blog/envoy-sidecar-injection-in-istio-service-mesh-deep-dive/</a></p><p><a href=https://cloud.tencent.com/developer/article/1552334 target=_blank rel="external nofollow noopener noreferrer">https://cloud.tencent.com/developer/article/1552334</a></p><p><a href=https://blog.csdn.net/qq_20365437/article/details/107702413 target=_blank rel="external nofollow noopener noreferrer">https://blog.csdn.net/qq_20365437/article/details/107702413</a></p><p><a href=https://academy.tetrate.io/courses/envoy-fundamentals target=_blank rel="external nofollow noopener noreferrer">https://academy.tetrate.io/courses/envoy-fundamentals</a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2023-03-02 14:01:06">更新于 2023-03-02&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/istio/ class=post-tag>istio</a><a href=/tags/envoy/ class=post-tag>envoy</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/tech/cloudnative/istio_proxy_log_level/ class=post-nav-item rel=prev title="调整Istio Proxy日志级别"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>调整Istio Proxy日志级别</a>
<a href=/tech/cloudnative/istio_ratelimit_circuit_breaker/ class=post-nav-item rel=next title=Istio熔断和限流工作原理>Istio熔断和限流工作原理<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2018 - 2023</span><span class=author itemprop=copyrightHolder>
<a href=/>大倬</a></span></div><div class="footer-line statistics"></div><div class="footer-line beian"><span class="icp footer-divider"><div class=beian><a href=https://beian.miit.gov.cn/ rel=noopener target=_blank>蜀ICP备2021011057号-2</a> | <img src=https://nuoyang.tech/beian.png alt><a href='http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=51019002002976' rel=noopener target=_blank>川公网安备51019002002976号</a></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class=variant-numeric>0%</span></div></div><div id=mask></div><div class=reading-progress-bar style="left:0;top:0;width:calc(100% - var(--progress))"></div><noscript><div class=noscript-warning>FixIt 主题在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/katex/katex.min.css><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/lunr/lunr.min.js defer></script><script src=/lib/lunr/lunr.stemmer.support.min.js defer></script><script src=/lib/lunr/lunr.zh.min.js defer></script><script src=/lib/typeit/index.umd.js defer></script><script src=/lib/katex/katex.min.js defer></script><script src=/lib/katex/auto-render.min.js defer></script><script src=/lib/katex/copy-tex.min.js defer></script><script src=/lib/katex/mhchem.min.js defer></script><script>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:10},comment:{enable:!1},data:{"typeit-header-desktop":"大倬","typeit-header-title-mobile":"大倬"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",lunrLanguageCode:"zh",lunrSegmentitURL:"/lib/lunr/lunr.segmentit.js",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:30,type:"lunr"},typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"typeit-header-desktop":["typeit-header-desktop"],"typeit-header-title-mobile":["typeit-header-title-mobile"]},duration:-1,loop:!1,speed:100}}</script><script src=/js/theme.min.js defer></script></body></html>